import{r as c,m as R,j as e,L as T,$ as k,S as f}from"./app-iXmw2z_F.js";import{I as p}from"./input-error-JX4fCH7R.js";import{I as y}from"./input-field-Babt2Miw.js";import{A as I}from"./app-layout-CUYHb3U_.js";import{S as q}from"./slimselect-COPtFSi2.js";import{L as B}from"./loader-circle-CjzKTp_M.js";import"./clsx-B-dksMZM.js";const X=({categories:S,movie:n})=>{var j;const u=c.useRef(null),[x,w]=c.useState(n.categories.map(s=>s.id)),[v,b]=c.useState(n.banner),[g,d]=c.useState(!1),[m,E]=c.useState({}),[O,V]=c.useState(0),[_,C]=c.useState({}),{data:r,setData:l,post:$,progress:h}=R({title:n.title,description:n.description,featured:n.featured,premium:n.premium,episode_number:n.episodes_count,existing_banner:n.banner_path,banner:null,categories:n.categories.map(s=>s.id),episodes:((j=n.episodes)==null?void 0:j.map(s=>({id:s.id,video:null,is_premium:s.is_premium,existing_video:s.video_path,active:s.active})))||Array(n.episode_count).fill(null).map(()=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),video:null,is_premium:!1}))});c.useEffect(()=>{const s=r.episode_number,i=r.episodes.length;if(s>i){const t=s-i,a=Array(t).fill(null).map(()=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),video:null,is_premium:!1}));l("episodes",[...r.episodes,...a])}else s<i&&l("episodes",r.episodes.slice(0,s))},[r.episode_number]);const D=s=>i=>{if(i.target.files&&i.target.files[0]){const t=i.target.files[0];l(s,t);{const a=new FileReader;a.onload=o=>{var N;(N=o.target)!=null&&N.result&&b(o.target.result)},a.readAsDataURL(t)}}},F=(s,i)=>{if(i.target.files&&i.target.files[0]){const t=i.target.files[0];if(!["video/mp4","video/x-m4v","video/quicktime"].includes(t.type)){alert("Only MP4, M4V, and QuickTime videos are allowed"),i.target.value="";return}l("episodes",r.episodes.map(o=>o.id===s?{...o,video:t}:o));const a=URL.createObjectURL(t);C(o=>({...o,[s.toString()]:a}))}},P=(s,i)=>{l("episodes",r.episodes.map(t=>t.id===s?{...t,is_premium:i}:t))},A=async s=>{s.preventDefault(),d(!0);const i={};if(r.title.trim()||(i.title="Title is required"),r.categories.length===0&&(i.categories="At least one category must be selected"),!r.banner&&!(n!=null&&n.banner_path)&&(i.banner="Banner image is required"),r.episodes.forEach((a,o)=>{!a.video&&!a.existing_video&&(i[`episodes.${o}.video`]="Episode video is required")}),Object.keys(i).length>0){E(i),d(!1);return}const t=new FormData;t.append("title",r.title),t.append("description",r.description),t.append("featured",r.featured?"1":"0"),t.append("premium",r.premium?"1":"0"),t.append("episode_number",r.episode_number.toString()),r.banner?t.append("banner",r.banner):n.banner_path&&t.append("existing_banner",n.banner_path),r.categories.forEach(a=>t.append("categories[]",a.toString())),r.episodes.forEach((a,o)=>{a.video?t.append(`episodes[${o}][video]`,a.video):a.existing_video&&t.append(`episodes[${o}][existing_video]`,a.existing_video),t.append(`episodes[${o}][id]`,a.id.toString()),t.append(`episodes[${o}][is_premium]`,a.is_premium?"1":"0")});try{await $(route("system.movie.update",n.id),{onSuccess:()=>{d(!1)},onError:a=>{d(!1),console.error("Update errors:",a)}})}catch(a){d(!1),console.error("Update error:",a)}},U=async(s,i)=>{if(confirm("Are you sure you want to delete this episode?")){d(!0);try{typeof s=="number"&&await f.delete(route("system.movie.episode.destroy",s),{preserveScroll:!0}),l("episodes",r.episodes.filter((t,a)=>a!==i)),l("episode_number",r.episode_number-1)}catch(t){console.error("Failed to delete episode:",t)}finally{d(!1)}}},L=async s=>{d(!0);try{await f.put(route("system.movie.episode.status",s.id),{},{preserveScroll:!0}),l("episodes",r.episodes.map(i=>i.id===s.id?{...i,active:!i.active}:i))}catch(i){console.error(`Failed to ${s.active?"disable":"enable"} episode:`,i)}finally{d(!1)}},M=async()=>{if(confirm("Are you sure you want to delete this poster?")){d(!0);try{await f.put(route("system.movie.banner.delete",n.id),{},{preserveScroll:!0,onSuccess:()=>{b(null),l("banner",null)}})}catch(s){console.error("Failed to remove banner:",s)}finally{d(!1)}}};return c.useEffect(()=>{if(u.current){x.length>0&&Array.from(u.current.options).forEach(i=>{x.includes(parseInt(i.value))&&(i.selected=!0)});const s=new q({select:u.current,settings:{showSearch:!0,placeholderText:"Select Categories",closeOnSelect:!1},events:{afterChange:i=>{const t=i.map(a=>parseInt(a.value));w(t),l("categories",t)}}});return()=>{s.destroy()}}},[u.current,x]),e.jsxs(e.Fragment,{children:[e.jsx(T,{title:"Mini Series"}),e.jsx(I,{title:"Mini Series",mainTitle:!0,children:e.jsx("div",{className:"col-12",children:e.jsx("form",{onSubmit:A,className:"sign__form sign__form--add",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 col-xl-6",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"sign__group",children:[e.jsx(y,{name:"title",value:r.title,onChange:(s,i)=>l(s,i),placeholder:"Title",error:m.title,required:!0}),e.jsx(p,{message:m.title})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"sign__group",children:[e.jsx("textarea",{className:`sign__textarea ${m.description?"is-invalid":""}`,placeholder:"Description",onChange:s=>l("description",s.target.value),value:r.description}),e.jsx(p,{message:m.description})]})}),v&&e.jsxs("div",{className:"col-12 mb-3",children:[e.jsx("div",{className:"mt-2 mb-3",children:e.jsx("img",{src:v,alt:"Banner preview",className:"img-thumbnail",style:{maxWidth:"200px",maxHeight:"200px"}})}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm",onClick:()=>M(),disabled:g,children:"Remove Poster"})]})]})}),e.jsx("div",{className:"col-12 col-xl-6",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"sign__group",children:[e.jsxs("div",{className:"sign__gallery",children:[e.jsx("label",{htmlFor:"sign__gallery-upload",children:"Upload Poster"}),e.jsx("input",{id:"sign__gallery-upload",name:"banner",className:"sign__gallery-upload",type:"file",accept:".png, .jpg, .jpeg",onChange:D("banner")})]}),e.jsx(p,{message:m.banner})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"sign__group",children:[e.jsx("label",{className:"sign__label",children:"No. of Episode:"}),e.jsx(y,{type:"number",name:"episode_number",value:r.episode_number,onChange:(s,i)=>{if(i==="")l(s,i);else{const t=parseInt(i);isNaN(t)||l(s,Math.max(1,t))}},placeholder:"No. of Episode"}),e.jsx(p,{message:m.episode_number})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"sign__group",children:[e.jsx("select",{className:"sign__selectjs",id:"sign__genre",ref:u,onChange:s=>l("categories",s.target.value),multiple:!0,children:S.data.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}),e.jsx(p,{message:m.categories})]})})]})}),e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"sign__episodes mt-4",children:[e.jsx("h4",{className:"sign__title",children:"Episodes"}),r.episodes.map((s,i)=>e.jsx("div",{className:"sign__episode mt-3",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-12 mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{className:"sign__episode-title",children:["Episode #",i+1]}),e.jsxs("div",{children:[e.jsxs("button",{type:"button",className:`btn btn-${s.active?"danger":"success"} btn-sm me-2`,onClick:()=>L(s),disabled:g,children:[s.active?"Disable":"Enable"," Episode #",i+1]}),e.jsxs("button",{type:"button",className:"btn btn-danger btn-sm",onClick:()=>U(s.id,i),disabled:g,children:["Delete Episode #",i+1]})]})]})}),e.jsx("div",{className:"col-12 col-md-8",children:e.jsxs("div",{className:"sign__video",children:[e.jsxs("label",{htmlFor:`episode-video-${s.id}`,children:["Upload episode ",i+1]}),e.jsx("input",{id:`episode-video-${s.id}`,type:"file",accept:"video/mp4,video/x-m4v,video/*",onChange:t=>F(s.id,t)})]})}),e.jsx("div",{className:"col-12 col-md-4",children:e.jsx("div",{className:"d-flex align-items-center gap-3",children:e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("select",{className:"form-select",value:s.is_premium?"1":"0",onChange:t=>P(s.id,t.target.value==="1"),children:[e.jsx("option",{value:"0",children:"Free"}),e.jsx("option",{value:"1",children:"Premium"})]}),e.jsx(p,{message:m[`episodes.${i}.is_premium`]})]})})}),_[s.id]?e.jsx("video",{src:_[s.id],controls:!0,style:{maxWidth:"300px"}},`new-${s.id}`):s.existing_video&&e.jsx("video",{src:s.existing_video,controls:!0,style:{maxWidth:"300px"}},`existing-${s.id}`)]})},s.id))]})}),e.jsxs("div",{className:"col-12 mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsx("button",{type:"submit",className:"sign__btn sign__btn--small",disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"animate-spin mr-2"}),"Processing..."]}):e.jsx("span",{children:"Publish"})}),e.jsx(k,{href:route("system.movie.index"),className:"sign__btn sign__btn--small",children:" Cancel"})]}),h&&e.jsxs("div",{className:"mt-4 text-white",children:[e.jsxs("p",{children:["Uploading: ",h.percentage,"%"]}),e.jsx("div",{className:"progress",children:e.jsxs("div",{className:"progress-bar bg-warning",role:"progressbar",style:{width:`${h.percentage}%`},"aria-valuemin":"0","aria-valuemax":"100",children:[h.percentage,"%"]})})]})]})]})})})})]})};export{X as default};
